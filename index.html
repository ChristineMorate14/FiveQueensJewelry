<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Five Queens Jewelry — Shop</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
<style>
  :root{--accent:#b76e79;--muted:#666;--bg:#fffdfb}
  *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#fff 0%,#fffdfb 100%);color:#111}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#ffd6e0,#b76e79);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  .search input{padding:10px;border-radius:10px;border:1px solid #eee;width:420px}
  .icons{display:flex;gap:8px}
  .btn{padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:white;cursor:pointer}
  .chip{padding:8px 10px;border-radius:999px;border:1px solid #eee;background:#fff;cursor:pointer}
  .grid{display:grid;grid-template-columns:280px 1fr;gap:16px;margin-top:18px}
  .card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
  .products{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}.search input{width:100%}.products{grid-template-columns:repeat(2,1fr)}}
  .product{border-radius:12px;overflow:hidden;border:1px solid #f3e3e8;background:linear-gradient(180deg,#fff,#fff7f9);padding:12px}
  .product img{width:100%;height:180px;object-fit:cover;border-radius:8px}
  .muted{color:var(--muted)}
  footer{padding:24px;text-align:center;color:var(--muted)}
  .hidden{display:none}
  .cart-modal{position:fixed;right:20px;bottom:20px;width:360px;background:white;padding:12px;border-radius:12px;box-shadow:0 18px 40px rgba(0,0,0,0.12)}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">FQ</div>
        <div>
          <div style="font-weight:700">Five Queens Jewelry</div>
          <div style="font-size:12px" class="muted">Shop like Shopee / Lazada / Amazon</div>
        </div>
      </div>

      <div class="search">
        <input id="searchInput" placeholder="Search products, e.g. ring, necklace..." />
      </div>

      <div class="icons">
        <div id="authArea"></div>
        <button class="chip" id="openCartBtn">Cart (<span id="cartCount">0</span>)</button>
        <button class="chip" id="openAdminBtn">Admin</button>
      </div>
    </header>

    <div class="grid">
      <aside class="card">
        <h3>Categories</h3>
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">
          <button class="chip cat" data-cat="all">All</button>
          <button class="chip cat" data-cat="rings">Rings</button>
          <button class="chip cat" data-cat="necklaces">Necklaces</button>
          <button class="chip cat" data-cat="earrings">Earrings</button>
          <button class="chip cat" data-cat="bracelets">Bracelets</button>
        </div>
        <div style="height:12px"></div>
        <div id="profileSummary" class="muted">Not logged in.</div>
      </aside>

      <section>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h2>Products</h2>
          <div class="muted" id="resultsInfo"></div>
        </div>

        <div id="products" class="products"></div>
      </section>
    </div>

    <div id="userOrdersSection" style="margin-top:18px"></div>

    <footer>
      <div style="font-weight:700">Five Queens Jewelry</div>
      <div class="muted">Demo shop — Netlify + Supabase (serverless)</div>
    </footer>
  </div>

  <!-- Cart modal -->
  <div id="cartModal" class="cart-modal hidden">
    <h4>Cart</h4>
    <div id="cartItems"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
      <strong>Total: ₱<span id="cartTotal">0</span></strong>
      <button class="btn" id="checkoutBtn">Checkout</button>
    </div>
  </div>

  <!-- Login/Register modal -->
  <div id="authModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center">
    <div style="width:760px;background:white;border-radius:12px;padding:18px;display:flex;gap:12px">
      <div style="flex:1">
        <h4>Register</h4>
        <label>Full name</label>
        <input id="regName" />
        <label>Email</label><input id="regEmail" type="email" />
        <label>Password</label><input id="regPass" type="password" />
        <label>Phone</label><input id="regPhone" />
        <label>Address</label><textarea id="regAddress" rows="2"></textarea>
        <div style="height:8px"></div>
        <button class="btn" id="doRegister">Create account</button>
      </div>
      <div style="flex:1">
        <h4>Login</h4>
        <label>Email</label><input id="loginEmail" type="email" />
        <label>Password</label><input id="loginPass" type="password" />
        <div style="height:8px"></div>
        <button class="btn" id="doLogin">Login</button>
      </div>
    </div>
  </div>

  <!-- Checkout modal -->
  <div id="checkoutModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center">
    <div style="width:720px;background:white;border-radius:12px;padding:18px">
      <h4>Checkout</h4>
      <div id="checkoutItems"></div>
      <div style="height:8px"></div>
      <label>Shipping address</label>
      <textarea id="checkoutAddress" rows="2"></textarea>
      <label>Phone</label>
      <input id="checkoutPhone" />
      <label>Payment method</label>
      <select id="paymentMethod">
        <option value="cod">Cash on Delivery</option>
        <option value="gcash">GCash (manual)</option>
        <option value="stripe">Credit Card (Stripe)</option>
        <option value="paypal">PayPal</option>
      </select>
      <div style="height:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="chip" id="cancelCheckout">Cancel</button>
        <button class="btn" id="confirmCheckout">Confirm & Pay</button>
      </div>
    </div>
  </div>

<script type="module">
/*
  SPA frontend:
  - Uses Supabase JS for auth on client
  - Uses Netlify Functions as '/.netlify/functions/*' for DB interactions and order creation
  - For simplicity in this starter, we assume the functions are available in the same repo.
*/

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = '%%SUPABASE_URL%%';  // replace in Netlify _redirects or use env injection in build
const SUPABASE_ANON = '%%SUPABASE_ANON_KEY%%';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

const productsEl = document.getElementById('products');
const searchInput = document.getElementById('searchInput');
const cartCountEl = document.getElementById('cartCount');
const cartModal = document.getElementById('cartModal');
const cartItemsEl = document.getElementById('cartItems');
const cartTotalEl = document.getElementById('cartTotal');
const cart = {}; // client-side cart {productId: qty}
let currentUser = null;

async function fetchProducts(q='', category='all'){
  const url = '/.netlify/functions/get-products?q='+encodeURIComponent(q)+'&cat='+encodeURIComponent(category);
  const res = await fetch(url);
  const data = await res.json();
  return data;
}

async function loadProducts(q='', cat='all'){
  const data = await fetchProducts(q,cat);
  document.getElementById('resultsInfo').textContent = `${data.length} results`;
  productsEl.innerHTML='';
  data.forEach(p=>{
    const el = document.createElement('div'); el.className='product';
    el.innerHTML = `
      <img src="${p.image_url||'placeholder.jpg'}" alt="${p.title}">
      <h4>${p.title}</h4>
      <div class="muted">${p.category || '—'}</div>
      <div style="height:8px"></div>
      <div style="font-weight:700">₱${Number(p.price).toLocaleString('en-PH')}</div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px">
        <button class="btn buy" data-id="${p.id}">Add to cart</button>
        <button class="chip view" data-id="${p.id}">View</button>
      </div>
    `;
    productsEl.appendChild(el);
  });
  attachProductHandlers();
}

function attachProductHandlers(){
  document.querySelectorAll('.buy').forEach(b=>{
    b.addEventListener('click',()=>{ const id=b.dataset.id; cart[id]=(cart[id]||0)+1; updateCartUI(); alert('Added to cart') })
  });
  document.querySelectorAll('.view').forEach(b=>{
    b.addEventListener('click',async ()=>{ const id=b.dataset.id; const res = await fetch('/.netlify/functions/get-product?id='+id); const p = await res.json(); alert(`${p.title}\n\n${p.description}\n\n₱${p.price}`) })
  });
}

function updateCartUI(){
  const keys = Object.keys(cart);
  let total=0,count=0;
  cartItemsEl.innerHTML='';
  keys.forEach(id=>{
    // fetch product details synchronously from DOM or call product endpoint; we'll call server for price
  });
  // For brevity, we'll fetch product list and compute total
  fetch('/.netlify/functions/get-products').then(r=>r.json()).then(all=>{
    cartItemsEl.innerHTML='';
    let t=0,c=0;
    Object.keys(cart).forEach(pid=>{
      const p = all.find(x=>x.id===pid);
      if(!p) return;
      const qty = cart[pid];
      t += Number(p.price)*qty; c += qty;
      const div = document.createElement('div');
      div.style.display='flex'; div.style.justifyContent='space-between'; div.style.marginBottom='6px';
      div.innerHTML = `<div>${p.title} • x ${qty}</div><div>₱${(p.price*qty).toLocaleString('en-PH')}</div>`;
      cartItemsEl.appendChild(div);
    });
    cartCountEl.textContent = c;
    cartTotalEl.textContent = t.toLocaleString('en-PH');
  });
}

document.getElementById('openCartBtn').addEventListener('click',()=>{
  cartModal.classList.toggle('hidden');
  updateCartUI();
});

document.getElementById('checkoutBtn').addEventListener('click',()=>{
  if(Object.keys(cart).length===0){alert('Cart empty'); return;}
  // open checkout modal and populate items
  const itemsDiv = document.getElementById('checkoutItems');
  itemsDiv.innerHTML = '';
  fetch('/.netlify/functions/get-products').then(r=>r.json()).then(all=>{
    let t=0;
    Object.keys(cart).forEach(pid=>{
      const p = all.find(x=>x.id===pid);
      const qty=cart[pid];
      t += Number(p.price)*qty;
      itemsDiv.innerHTML += `<div style="display:flex;justify-content:space-between">${p.title} x ${qty} <strong>₱${(p.price*qty).toLocaleString('en-PH')}</strong></div>`;
    })
    document.getElementById('checkoutAddress').value = currentUser ? (currentUser.address||'') : '';
    document.getElementById('checkoutPhone').value = currentUser ? (currentUser.phone||'') : '';
    document.getElementById('checkoutModal').classList.remove('hidden');
  });
});

document.getElementById('cancelCheckout').addEventListener('click',()=>document.getElementById('checkoutModal').classList.add('hidden'));

document.getElementById('confirmCheckout').addEventListener('click', async ()=>{
  const addr = document.getElementById('checkoutAddress').value.trim();
  const phone = document.getElementById('checkoutPhone').value.trim();
  const pm = document.getElementById('paymentMethod').value;
  if(!addr || !phone){ alert('Fill address & phone'); return; }
  // create order
  const payload = {items: Object.keys(cart).map(id=>({product_id:id, qty:cart[id]})), shipping_address: addr, phone, payment_method: pm};
  const res = await fetch('/.netlify/functions/create-order', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  const data = await res.json();
  if(data.error){ alert('Error: '+data.error); return; }
  // If payment method is stripe or paypal we should redirect to checkout link returned by server
  if(data.checkout_url){ window.location = data.checkout_url; return; }
  // else success (cod/gcash simulated)
  alert('Order created: ' + data.order_id);
  // clear cart
  Object.keys(cart).forEach(k=>delete cart[k]);
  updateCartUI();
  document.getElementById('checkoutModal').classList.add('hidden');
  loadUserOrders();
});


// ---------------- Auth (Supabase) ----------------
function renderAuthArea(){
  const t = document.getElementById('authArea');
  if(currentUser){
    t.innerHTML = `<span style="font-weight:700">${currentUser.full_name||currentUser.email}</span> <button class="chip" id="logoutBtn">Logout</button>`;
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      await supabase.auth.signOut(); currentUser=null; renderAuthArea(); loadUserOrders();
    });
  } else {
    t.innerHTML = `<button class="chip" id="openAuth">Login / Register</button>`;
    document.getElementById('openAuth').addEventListener('click',()=>document.getElementById('authModal').classList.remove('hidden'));
  }
}

document.getElementById('doRegister').addEventListener('click', async ()=>{
  const name = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const pass = document.getElementById('regPass').value;
  const phone = document.getElementById('regPhone').value;
  const address = document.getElementById('regAddress').value;
  if(!email || !pass || !name){ alert('Fill name, email and password'); return;}
  const { user, error } = await supabase.auth.signUp({ email, password: pass }, {data:{full_name:name}});
  if(error){ alert(error.message); return; }
  // after signup, create profile row via server or handle via supabase auth trigger; for starter we store profile via function
  await fetch('/.netlify/functions/create-profile', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:user.id, full_name:name, phone, address})});
  alert('Check your email for confirmation. You may sign in now.');
  document.getElementById('authModal').classList.add('hidden');
});

document.getElementById('doLogin').addEventListener('click', async ()=>{
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value;
  const { user, error } = await supabase.auth.signIn({ email, password: pass });
  if(error){ alert(error.message); return; }
  const { data:profile } = await supabase.from('profiles').select('*').eq('id', user.id).single();
  currentUser = profile || {id:user.id, full_name:user.email, email:user.email};
  renderAuthArea();
  document.getElementById('authModal').classList.add('hidden');
  loadUserOrders();
});

// auto session restore
supabase.auth.onAuthStateChange(async (event, session) => {
  if(session && session.user){
    const { data:profile } = await supabase.from('profiles').select('*').eq('id', session.user.id).single();
    currentUser = profile || {id: session.user.id, email: session.user.email};
  } else currentUser = null;
  renderAuthArea();
});

async function loadUserOrders(){
  const el = document.getElementById('userOrdersSection');
  if(!currentUser){ el.innerHTML = `<div class="card"><h4>Order History</h4><div class="muted">Login to view your orders.</div></div>`; return; }
  const res = await fetch('/.netlify/functions/get-orders?user_id=' + currentUser.id);
  const json = await res.json();
  el.innerHTML = `<div class="card"><h4>Order History (${json.length})</h4>` + (json.length ? json.map(o=>`<div style="padding:8px;border:1px solid #f3e3e8;border-radius:8px;margin-bottom:8px"><strong>Order ${o.id}</strong><div class="muted">Status: ${o.status} • ${o.created_at.split('T')[0]}</div></div>`).join('') : `<div class="muted">No orders yet.</div>`) + `</div>`;
}

// admin area (simple prompt for admin password that triggers admin panel)
document.getElementById('openAdminBtn').addEventListener('click', async ()=>{
  // In production use supabase admin flag; here simple flow to show admin panel
  const key = prompt('Enter admin secret (set in Netlify environment)'); if(!key) return;
  const res = await fetch('/.netlify/functions/admin-auth?key='+encodeURIComponent(key));
  const j = await res.json();
  if(j.ok){ openAdminPanel(); } else alert('Invalid admin key');
});

function openAdminPanel(){
  const win = window.open('', '_blank');
  win.document.write('<h2>Admin Panel</h2><div id="content">Loading...</div><script>fetch("/.netlify/functions/get-orders").then(r=>r.json()).then(j=>{document.getElementById("content").innerHTML = "<pre>"+JSON.stringify(j,null,2)+"</pre>"});<\/script>');
}

// search + categories
searchInput.addEventListener('input', e => loadProducts(e.target.value, 'all'));
document.querySelectorAll('.cat').forEach(b=>b.addEventListener('click', ()=> loadProducts('', b.dataset.cat)));

loadProducts(); renderAuthArea(); updateCartUI(); loadUserOrders();

</script>
</body>
</html>
